version: "3.7"
services:

  ## --------------------------- PASSBOLT DB --------------------------- ##
  db:
    image: mariadb:10.11
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_DATABASE={{ db_name }}
      - MYSQL_USER={{ db_user }}
      - MYSQL_PASSWORD={{ db_password }}
    volumes:
      - passbolt_database:/var/lib/mysql
    networks:
      - {{ network_name }}
    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M

  ## --------------------------- PASSBOLT APP --------------------------- ##
  passbolt:
    image: passbolt/passbolt:latest-ce
    depends_on:
      - db
    environment:
      - APP_FULL_BASE_URL=https://{{ domain }}
      - DATASOURCES_DEFAULT_HOST=db
      - DATASOURCES_DEFAULT_USERNAME={{ db_user }}
      - DATASOURCES_DEFAULT_PASSWORD={{ db_password }}
      - DATASOURCES_DEFAULT_DATABASE={{ db_name }}
      - EMAIL_DEFAULT_FROM={{ smtp_email }}
      - EMAIL_DEFAULT_TRANSPORT=Smtp
      - EMAIL_TRANSPORT_DEFAULT_HOST={{ smtp_host }}
      - EMAIL_TRANSPORT_DEFAULT_PORT={{ smtp_port }}
      - EMAIL_TRANSPORT_DEFAULT_USERNAME={{ smtp_user }}
      - EMAIL_TRANSPORT_DEFAULT_PASSWORD={{ smtp_password }}
      - EMAIL_TRANSPORT_DEFAULT_TLS={{ smtp_tls }}
      - TZ=America/Sao_Paulo
    command:
      [
        "/usr/bin/wait-for.sh",
        "-t",
        "0",
        "db:3306",
        "--",
        "/docker-entrypoint.sh"
      ]
    volumes:
      - passbolt_gpg:/etc/passbolt/gpg
      - passbolt_jwt:/etc/passbolt/jwt
    networks:
      - {{ network_name }}
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "1"
          memory: 1024M
      labels:
        - traefik.enable=true
        - traefik.http.routers.passbolt.rule=Host(`{{ domain }}`)
        - traefik.http.routers.passbolt.entrypoints=websecure
        - traefik.http.routers.passbolt.tls.certresolver=letsencryptresolver
        - traefik.http.services.passbolt.loadbalancer.server.port=80
        - traefik.http.routers.passbolt.service=passbolt

## --------------------------- VOLUMES / NETWORK --------------------------- ##
volumes:
  passbolt_database:
    external: true
    name: passbolt_database
  passbolt_gpg:
    external: true
    name: passbolt_gpg
  passbolt_jwt:
    external: true
    name: passbolt_jwt

networks:
  {{ network_name }}:
    external: true
    name: {{ network_name }}
